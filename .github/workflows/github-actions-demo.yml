name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€

on:
    # Triggers on push to remote
    push:
        # For specific branches
        # branches: [main]
    # The workflow_dispatch event adds a button we can use to manually trigger
    workflow_dispatch:

jobs:
  Build-And-Test:
    # "runs-on" specifies the github hosted VM (not a container image- I think)
    runs-on: ubuntu-latest
    # To run inside of a container on the github hosted VM
    # container:
    #     image: golang:1.21.5-bullseye
    permissions:
        # Test publisher requires these perms
        checks: write
        pull-requests: write
    steps:
      -
        name: Echo Build Info
        run: |
            echo "github.event_name - ${{ github.event_name }}"
            echo "runner.os - ${{ runner.os }}"
            echo "github.ref - ${{ github.ref }}"
            echo "github.repository - ${{ github.repository }}"
            echo "github.workspace - ${{ github.workspace }}"
            echo "job.status - ${{ job.status }}"

      -
        name: Check out repo
        uses: actions/checkout@v4

      ##################### BUILD SETUP #####################
      # TODO: what is "actions/setup-go@v4" doing???
      -
        name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'
      -
        name: Install Dagger 
        run: go get dagger.io/dagger@latest
      - name: Install Dagger CLI
        run: cd /usr/local && { curl -L https://dl.dagger.io/dagger/install.sh | sh; cd -; }

      ##################### BUILD #####################
      -
        name: Dagger Build
        run: |
            make

      ##################### REPORT #####################
      -
        name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            build/unit-tests.xml
